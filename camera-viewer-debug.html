        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a1a;
            color: #e0e0e0;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        h1 {
            color: #4a9eff;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #666;
        }
        
        .status-dot.connected {
            background: #4ade80;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
        }
        
        .panel {
            background: #2a2a2a;
            border-radius: 10px;
            padding: 20px;
        }
        
        .video-container {
            position: relative;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            aspect-ratio: 16/9;
        }
        
        #videoDisplay {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        .no-feed {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #666;
        }
        
        .controls {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        button {
            background: #4a9eff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        button:hover {
            background: #3a8eef;
            transform: translateY(-1px);
        }
        
        button:disabled {
            background: #444;
            cursor: not-allowed;
            transform: none;
        }
        
        button.danger {
            background: #ef4444;
        }
        
        button.success {
            background: #4ade80;
        }
        
        input, select, textarea {
            background: #1a1a1a;
            border: 1px solid #444;
            color: #e0e0e0;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            width: 100%;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: #999;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Diagnostics Panel */
        .diagnostics {
            background: #1a1a1a;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }
        
        .diagnostics-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            cursor: pointer;
            user-select: none;
        }
        
        .diagnostics-header:hover {
            color: #4a9eff;
        }
        
        .diagnostics h3 {
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .diagnostics-content {
            display: none;
        }
        
        .diagnostics.expanded .diagnostics-content {
            display: block;
        }
        
        .log-console {
            background: #0a0a0a;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
        }
        
        .log-entry {
            margin-bottom: 5px;
            padding: 3px 5px;
        }
        
        .log-info {
            color: #4a9eff;
        }
        
        .log-success {
            color: #4ade80;
        }
        
        .log-warning {
            color: #fbbf24;
        }
        
        .log-error {
            color: #ef4444;
        }
        
        .log-debug {
            color: #999;
        }
        
        .timestamp {
            color: #666;
            margin-right: 8px;
        }
        
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .test-item {
            background: #333;
            padding: 10px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .test-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #666;
        }
        
        .test-status.success {
            background: #4ade80;
        }
        
        .test-status.failed {
            background: #ef4444;
        }
        
        .test-status.testing {
            background: #fbbf24;
            animation: pulse 1s infinite;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #444;
        }
        
        .info-item {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
        }
        
        .info-label {
            color: #999;
        }
        
        .info-value {
            color: #4a9eff;
            font-weight: 600;
        }
        
        .expand-icon {
            transition: transform 0.3s;
        }
        
        .diagnostics.expanded .expand-icon {
            transform: rotate(90deg);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ü§ñ Robot Overhead Monitor - Debug Mode</h1>
            <div class="status">
                <span id="statusText">Disconnected</span>
                <div class="status-dot" id="statusDot"></div>
            </div>
        </header>
        
        <div class="main-grid">
            <div class="panel">
                <h2 style="margin-bottom: 15px;">Camera Feed</h2>
                
                <div class="video-container">
                    <img id="videoDisplay" style="display:none;" />
                    <video id="videoElement" style="display:none; width:100%; height:100%;" autoplay></video>
                    <div class="no-feed" id="noFeed">
                        <div style="font-size: 48px;">üìπ</div>
                        <p>No camera feed</p>
                        <p style="font-size: 12px; margin-top: 10px;">Check diagnostics below for connection issues</p>
                    </div>
                </div>
                
                <div class="controls">
                    <button id="testConnection" onclick="testAllConnections()">üîç Test All URLs</button>
                    <button id="connectBtn" onclick="connectCamera()">Connect Camera</button>
                    <button id="disconnectBtn" onclick="disconnectCamera()" disabled>Disconnect</button>
                    <button onclick="captureSnapshot()">üì∏ Snapshot</button>
                    <button onclick="clearLogs()" class="danger">Clear Logs</button>
                </div>
                
                <div class="info-grid">
                    <div class="info-item">
                        <span class="info-label">Camera IP:</span>
                        <span class="info-value">192.168.88.40</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Status:</span>
                        <span class="info-value" id="cameraStatus">Disconnected</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Protocol:</span>
                        <span class="info-value" id="protocolStatus">--</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">FPS:</span>
                        <span class="info-value" id="fps">--</span>
                    </div>
                </div>
                
                <!-- Diagnostics Section -->
                <div class="diagnostics" id="diagnosticsPanel">
                    <div class="diagnostics-header" onclick="toggleDiagnostics()">
                        <h3>üìä DIAGNOSTICS & LOGGING</h3>
                        <span class="expand-icon">‚ñ∂</span>
                    </div>
                    <div class="diagnostics-content">
                        <div class="test-grid" id="testResults">
                            <!-- Test results will appear here -->
                        </div>
                        
                        <h4 style="margin-top: 15px; margin-bottom: 10px; color: #999;">Console Log</h4>
                        <div class="log-console" id="logConsole">
                            <div class="log-entry log-info">
                                <span class="timestamp"></span>System initialized. Ready to connect.
                            </div>
                        </div>
                        
                        <div style="margin-top: 10px;">
                            <label>Manual URL Test</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="text" id="manualUrl" placeholder="Enter camera URL to test" />
                                <button onclick="testManualUrl()" style="width: auto;">Test</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="panel">
                <h2 style="margin-bottom: 15px;">Configuration</h2>
                
                <div class="input-group">
                    <label>Camera Protocol</label>
                    <select id="cameraProtocol" onchange="updateCameraURL()">
                        <option value="rtsp">RTSP Stream</option>
                        <option value="http">HTTP Snapshot</option>
                        <option value="mjpeg">MJPEG Stream</option>
                        <option value="proxy">Via Proxy Server</option>
                    </select>
                </div>
                
                <div class="input-group">
                    <label>Camera URL</label>
                    <input type="text" id="cameraURL" value="rtsp://192.168.88.40:554/stream1" />
                </div>
                
                <div class="input-group">
                    <label>Username (optional)</label>
                    <input type="text" id="username" value="LeKiwi" />
                </div>
                
                <div class="input-group">
                    <label>Password (optional)</label>
                    <input type="password" id="password" value="LeKiwi995" />
                </div>
                
                <h3 style="margin-top: 20px; margin-bottom: 10px;">Quick Test URLs</h3>
                <div style="display: flex; flex-direction: column; gap: 5px;">
                    <button onclick="setURL('rtsp://192.168.88.40:554/stream1')" style="font-size: 12px;">RTSP: /stream1</button>
                    <button onclick="setURL('rtsp://192.168.88.40:554/1')" style="font-size: 12px;">RTSP: /1</button>
                    <button onclick="setURL('rtsp://192.168.88.40:554/live')" style="font-size: 12px;">RTSP: /live</button>
                    <button onclick="setURL('http://192.168.88.40/snapshot.jpg')" style="font-size: 12px;">HTTP: /snapshot.jpg</button>
                    <button onclick="setURL('http://192.168.88.40/image.jpg')" style="font-size: 12px;">HTTP: /image.jpg</button>
                    <button onclick="setURL('http://192.168.88.40/mjpg/video.mjpg')" style="font-size: 12px;">MJPEG: /mjpg/video.mjpg</button>
                    <button onclick="setURL('http://localhost:3001/stream.mjpeg')" style="font-size: 12px;">Proxy: localhost:3001</button>
                </div>
                
                <h3 style="margin-top: 20px; margin-bottom: 10px;">Connection Help</h3>
                <div style="background: #1a1a1a; padding: 10px; border-radius: 4px; font-size: 12px; line-height: 1.5;">
                    <p><strong>RTSP Issues?</strong></p>
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li>Ensure FFmpeg is installed: <code>brew install ffmpeg</code></li>
                        <li>Try with/without authentication</li>
                        <li>Common ports: 554, 8554, 10554</li>
                    </ul>
                    
                    <p style="margin-top: 10px;"><strong>Using Proxy Server:</strong></p>
                    <ol style="margin-left: 20px; margin-top: 5px;">
                        <li>Run: <code>node rtsp-proxy.js</code></li>
                        <li>Select "Via Proxy Server" protocol</li>
                        <li>URL will auto-update to proxy endpoint</li>
                    </ol>
                    
                    <p style="margin-top: 10px;"><strong>Test with VLC:</strong></p>
                    <code style="display: block; margin-top: 5px; padding: 5px; background: #0a0a0a;">
                        vlc rtsp://192.168.88.40:554/stream1
                    </code>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let isConnected = false;
        let frameInterval = null;
        let logs = [];
        
        // Logging functions
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const entry = { timestamp, message, type };
            logs.push(entry);
            
            const console = document.getElementById('logConsole');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `<span class="timestamp">${timestamp}</span>${message}`;
            console.appendChild(logEntry);
            
            // Auto-scroll to bottom
            console.scrollTop = console.scrollHeight;
            
            // Limit to 100 entries
            while (console.children.length > 100) {
                console.removeChild(console.firstChild);
            }
            
            // Also log to browser console
            console.log(`[${type.toUpperCase()}] ${timestamp} - ${message}`);
        }
        
        function clearLogs() {
            document.getElementById('logConsole').innerHTML = '';
            logs = [];
            log('Logs cleared', 'info');
        }
        
        // Toggle diagnostics panel
        function toggleDiagnostics() {
            const panel = document.getElementById('diagnosticsPanel');
            panel.classList.toggle('expanded');
        }
        
        // Test all connections
        async function testAllConnections() {
            log('Starting comprehensive connection tests...', 'info');
            const testResults = document.getElementById('testResults');
            testResults.innerHTML = '';
            
            const urls = [
                { name: 'RTSP /stream1', url: 'rtsp://192.168.88.40:554/stream1' },
                { name: 'RTSP /1', url: 'rtsp://192.168.88.40:554/1' },
                { name: 'RTSP /live', url: 'rtsp://192.168.88.40:554/live' },
                { name: 'RTSP /ch0', url: 'rtsp://192.168.88.40:554/ch0_0.h264' },
                { name: 'HTTP Snapshot', url: 'http://192.168.88.40/snapshot.jpg' },
                { name: 'HTTP Image', url: 'http://192.168.88.40/image.jpg' },
                { name: 'MJPEG Stream', url: 'http://192.168.88.40/mjpg/video.mjpg' },
                { name: 'Proxy MJPEG', url: 'http://localhost:3001/stream.mjpeg' },
                { name: 'Proxy Snapshot', url: 'http://localhost:3001/snapshot.jpg' }
            ];
            
            for (const test of urls) {
                const testItem = document.createElement('div');
                testItem.className = 'test-item';
                testItem.innerHTML = `
                    <span>${test.name}</span>
                    <div class="test-status testing"></div>
                `;
                testResults.appendChild(testItem);
                
                // Test the URL
                const result = await testURL(test.url);
                const status = testItem.querySelector('.test-status');
                
                if (result.success) {
                    status.className = 'test-status success';
                    log(`‚úÖ ${test.name}: SUCCESS`, 'success');
                } else {
                    status.className = 'test-status failed';
                    log(`‚ùå ${test.name}: ${result.error}`, 'error');
                }
            }
            
            log('Connection tests completed', 'info');
        }
        
        // Test a single URL
        async function testURL(url) {
            try {
                if (url.startsWith('rtsp://')) {
                    // RTSP requires special handling
                    log(`Testing RTSP: ${url}`, 'debug');
                    // Would need FFmpeg or proxy to test properly
                    return { success: false, error: 'RTSP requires proxy server' };
                } else {
                    // HTTP/MJPEG can be tested directly
                    const response = await fetch(url, { 
                        method: 'HEAD',
                        mode: 'no-cors',
                        cache: 'no-cache'
                    }).catch(err => {
                        // no-cors means we can't read response, but connection attempt was made
                        return { ok: true };
                    });
                    
                    // For no-cors, we assume success if no error thrown
                    return { success: true };
                }
            } catch (error) {
                return { success: false, error: error.message };
            }
        }
        
        // Test manual URL
        async function testManualUrl() {
            const url = document.getElementById('manualUrl').value;
            if (!url) {
                log('Please enter a URL to test', 'warning');
                return;
            }
            
            log(`Testing manual URL: ${url}`, 'info');
            const result = await testURL(url);
            
            if (result.success) {
                log(`‚úÖ Manual URL test SUCCESS`, 'success');
                if (confirm('Test successful! Use this URL?')) {
                    document.getElementById('cameraURL').value = url;
                }
            } else {
                log(`‚ùå Manual URL test failed: ${result.error}`, 'error');
            }
        }
        
        // Set URL
        function setURL(url) {
            document.getElementById('cameraURL').value = url;
            log(`URL set to: ${url}`, 'info');
            
            // Auto-detect protocol
            if (url.startsWith('rtsp://')) {
                document.getElementById('cameraProtocol').value = 'rtsp';
            } else if (url.includes('mjpeg') || url.includes('mjpg')) {
                document.getElementById('cameraProtocol').value = 'mjpeg';
            } else if (url.includes('snapshot') || url.includes('image')) {
                document.getElementById('cameraProtocol').value = 'http';
            }
        }
        
        // Update camera URL based on protocol
        function updateCameraURL() {
            const protocol = document.getElementById('cameraProtocol').value;
            const urlInput = document.getElementById('cameraURL');
            
            switch(protocol) {
                case 'rtsp':
                    urlInput.value = 'rtsp://192.168.88.40:554/stream1';
                    log('Protocol changed to RTSP', 'info');
                    break;
                case 'http':
                    urlInput.value = 'http://192.168.88.40/snapshot.jpg';
                    log('Protocol changed to HTTP Snapshot', 'info');
                    break;
                case 'mjpeg':
                    urlInput.value = 'http://192.168.88.40/mjpg/video.mjpg';
                    log('Protocol changed to MJPEG', 'info');
                    break;
                case 'proxy':
                    urlInput.value = 'http://localhost:3001/stream.mjpeg';
                    log('Protocol changed to Proxy Server', 'info');
                    break;
            }
            
            document.getElementById('protocolStatus').textContent = protocol.toUpperCase();
        }
        
        // Connect to camera
        async function connectCamera() {
            const protocol = document.getElementById('cameraProtocol').value;
            const url = document.getElementById('cameraURL').value;
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            log(`Attempting to connect: ${url}`, 'info');
            
            if (protocol === 'rtsp') {
                log('RTSP requires proxy server. Starting proxy connection...', 'warning');
                alert('RTSP streams require the proxy server.\n\n1. Run: node rtsp-proxy.js\n2. Switch to "Via Proxy Server" protocol');
                return;
            }
            
            try {
                if (protocol === 'http') {
                    connectHTTPSnapshot(url, username, password);
                } else if (protocol === 'mjpeg' || protocol === 'proxy') {
                    connectMJPEG(url, username, password);
                }
            } catch (error) {
                log(`Connection failed: ${error.message}`, 'error');
            }
        }
        
        // Connect to HTTP snapshot
        function connectHTTPSnapshot(url, username, password) {
            const img = document.getElementById('videoDisplay');
            const noFeed = document.getElementById('noFeed');
            
            img.style.display = 'block';
            noFeed.style.display = 'none';
            
            let errorCount = 0;
            
            // Poll for new snapshots
            frameInterval = setInterval(() => {
                const timestamp = Date.now();
                let finalUrl = url + (url.includes('?') ? '&' : '?') + 't=' + timestamp;
                
                // Add auth if provided
                if (username && password) {
                    // Basic auth in URL (may not work in all browsers)
                    const urlParts = finalUrl.split('://');
                    finalUrl = urlParts[0] + '://' + username + ':' + password + '@' + urlParts[1];
                }
                
                img.onerror = () => {
                    errorCount++;
                    if (errorCount > 5) {
                        log(`HTTP snapshot failed after ${errorCount} attempts`, 'error');
                        disconnectCamera();
                    }
                };
                
                img.onload = () => {
                    errorCount = 0; // Reset on success
                    if (!isConnected) {
                        isConnected = true;
                        updateStatus('Connected', true);
                        enableControls(true);
                        log('HTTP snapshot connection established', 'success');
                    }
                };
                
                img.src = finalUrl;
            }, 100); // 10 FPS
        }
        
        // Connect to MJPEG stream
        function connectMJPEG(url, username, password) {
            const img = document.getElementById('videoDisplay');
            const noFeed = document.getElementById('noFeed');
            
            img.style.display = 'block';
            noFeed.style.display = 'none';
            
            // Add auth if provided
            if (username && password) {
                const urlParts = url.split('://');
                url = urlParts[0] + '://' + username + ':' + password + '@' + urlParts[1];
            }
            
            img.onerror = () => {
                log('MJPEG stream connection failed', 'error');
                disconnectCamera();
            };
            
            img.onload = () => {
                isConnected = true;
                updateStatus('Connected', true);
                enableControls(true);
                log('MJPEG stream connected successfully', 'success');
            };
            
            img.src = url;
        }
        
        // Disconnect camera
        function disconnectCamera() {
            if (frameInterval) {
                clearInterval(frameInterval);
                frameInterval = null;
            }
            
            const img = document.getElementById('videoDisplay');
            const noFeed = document.getElementById('noFeed');
            
            img.style.display = 'none';
            noFeed.style.display = 'block';
            img.src = '';
            
            isConnected = false;
            updateStatus('Disconnected', false);
            enableControls(false);
            
            log('Camera disconnected', 'info');
        }
        
        // Capture snapshot
        function captureSnapshot() {
            if (!isConnected) {
                log('Cannot capture snapshot - not connected', 'warning');
                return;
            }
            
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = document.getElementById('videoDisplay');
            
            canvas.width = img.naturalWidth || 640;
            canvas.height = img.naturalHeight || 480;
            ctx.drawImage(img, 0, 0);
            
            canvas.toBlob((blob) => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `snapshot_${Date.now()}.jpg`;
                a.click();
                URL.revokeObjectURL(url);
                log('Snapshot captured', 'success');
            }, 'image/jpeg', 0.9);
        }
        
        // Update status display
        function updateStatus(text, connected) {
            document.getElementById('statusText').textContent = text;
            document.getElementById('cameraStatus').textContent = text;
            const dot = document.getElementById('statusDot');
            
            if (connected) {
                dot.classList.add('connected');
            } else {
                dot.classList.remove('connected');
            }
        }
        
        // Enable/disable controls
        function enableControls(connected) {
            document.getElementById('connectBtn').disabled = connected;
            document.getElementById('disconnectBtn').disabled = !connected;
        }
        
        // Calculate FPS
        let lastTime = Date.now();
        let frames = 0;
        setInterval(() => {
            const now = Date.now();
            const elapsed = (now - lastTime) / 1000;
            const fps = Math.round(frames / elapsed);
            document.getElementById('fps').textContent = isConnected ? fps : '--';
            frames = 0;
            lastTime = now;
        }, 1000);
        
        // Count frames
        setInterval(() => {
            if (isConnected) frames++;
        }, 100);
        
        // Initialize
        log('System initialized - Camera Viewer Debug Mode', 'info');
        log('Camera IP: 192.168.88.40', 'info');
        log('Credentials loaded: LeKiwi', 'info');
        log('Click "Test All URLs" to scan for available endpoints', 'info');
        
        // Don't auto-expand diagnostics on load - user can click to expand
        // toggleDiagnostics();
    </script>
</body>
</html>